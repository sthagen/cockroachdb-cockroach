# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "id": 1,
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "id": 2,
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U2Fu2zYY_R2d4oP_2BksRbJRoJARYKrDdNpcOZCUrkUQEBRFrUQlMhUpTd4woIfIVXaBHSUnGShljrspC7p2_mFAnx7fe3x6n23Da1YrLoUPa0nf15LQd2cvgHWMZg0vc1aDZkpDO6AsK0Ep5ESTjCgGpzA1b6crANuGnBWkKTW0pGyYDwOUK60-lHAKsihGYaTRsodykbMO14zKqmIiJ5pLoTATJCtZ_i8Ef7laby6TFMWQoDQNo5dQMKKbmjkto1rWuKd3Huimum7YuPOClIqNcqoPpUPrPMNcaFYLUjra8OFa_oyVJporzalyiMKywJpXfUS298fvalzJ9lz1qNA9VjkPIU5lUYwz7WMcYzLWlGMgFdGcYirLklET8GEg_bXH2U1W_4W94sLkMiSkjMizcYFnrvsEfyFrRonS6utZVjulWYX7T6iwucAw_woCLaND4XKmWV1x0TcDF7xrbtTntNC6TFC_gitrHaMgRZAGLzYIbpqs5NTpYGYdEQij9DlE2xSiy81mbh1l95Phab2NkjQOwiiFDt-8Zzu4iMNXQfwWfkBvYUYgSNbHc-sojM7QG-hwhnnewSzr59bxyrKCjbngoGzMOHv5MPoerVNI0iANkzRcJzC9sgAAfu3_zW9C2p-w4r-wiQ_u_GFMZdlUQk18uNoPB_xk_3x9iK8Z0SzHRE98mCxc77nterbrgev5ruu77uQAbHaGC6oxlY0wBzz3UPsdV1qapmK9uzHGJoeHeW4OHAxEU5Z7pkMes_h7hcXSWyz7d7_NvzSD7H_JoHf4eTEsviQG63q6eqrCO1Ph5h8Vbh-r8G6kws2nFd7hdqhw-3SFd6MVNr4fPxGcncEnjlpcGE_n2xiFL6PBU3sMMTpHMYrWKPnb1syIsYTeXGyCMILZ9iKdA4peH0OCNsbLN3Aeb19BBz9-h2IEGZzCcmXZtm1bihIB3bf3W2rB3e3t3e3Hu9uPQKVQuiZcaB9OFieeD1cnS7DhZHlt_RkAAP__TSxNrw==


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VGFu2zYY_R2d4oP_2B4sR4pRoJARYKrDdNpcOZCUrkUQEBRFrVxlMhUpTdowoNgZ_HPX2AV2lJxkoJQ57qos6Nr5hwF9fHzv8elRtg0vWam4FB6sJH1bSkLfnD0D1jCaVrzIWAmaKQ11j7KsGCWQEU1SohicwtisjpcAtg0Zy0lVaKhJUTEPeihXWr0r4BRkng_CSKVlB-UiYw0uGZXbLRMZ0VwKhZkgacGyfyH429VqfRknKIIYJUkQPoecEV2VbF4zqmWJO_r5Pd1YlxUbdp6TQrFBTvWumNMySzEXmpWCFHNt-HApf8JKE82V5lTNicIyx5pvu4hs988_1LCS7TrqQaE7rJrfhziWeT7MtI9xiMlYU3MD2RLNKaayKBg1AR8G0h17mN1k9V_Yt1yYXPqElBF5MizwxHEe4c9lyShRWn05y6pVmm1x9woVNgfo519AoGa0L1zGNCu3XHTNwDlvqhv1KS20LmPUXcGltYqQnyBI_GdrBDdVWnA6b2BiHREIwuQphJsEwsv1emYdpXeT_mm1CeMk8oMwgQbfvGUtXETBCz96Dd-h1zAh4Mer6cw6CsIz9AoanGKeNTBJu7k1XVqWvzYH7JWNmflePgi_RasE4sRPgjgJVjGMrywAgF-6f_MbkfoHrPjPbOSBM7sfU1lUW6FGHlzthz1-tH--PsSXjGiWYaJHHoxOHPep7bi244Ljeo7jOc7oAGzuDBdUYyorYTa4zqH2G660NE3Fur0xxkaHm3lmNhwMRFUUe6ZDHnPx9wonC_dk0a39OvvcDNL_JYPO4afFcPI5MVjX4-VjFW5NhauPKlw_VOF2oMLVhxVucd1XuH68wu1ghY3vh3f4Z2fwgaMa58bT-SZCwfOw91RPIULnKELhCsX_uDUTYiyhVxdrPwhhsrlIZoDCl1OI0dp4-QrOo80LaGbQwvffoAhBCqewWFq2bdsWF4KV9o-SC5jQUio1teB29_vt7v3t7j0oSgS0H02ar-8utln5zbyd293uDkClULokXGgPjk-OXQ-ujhdgw_Hi2jqA5bzQrFQwMR-tqfVXAAAA__-LM3G4

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgdLkFMUKGzkQXWYQpsrB5JStAgCgqKuVq4ymYqUIm8Y0I_I435jP7BPyZcMlDLH3ZQFXTs_GNbl4TmHx4dyXXiDlRZKLmCl-IdKMf7-9CVgizyrRZljBQa1gaZHOU5CUsiZYRnTCCcwtqvjJYDrQo4Fq0sDDStrXEAPFdrojyWcgCqKQRirjeqgQubY0gq52m5R5swIJTVFybIS838h-MvVan2RpCSGhKRpGL2CApmpK_Qa5EZVtKP3HujGpqpx2HnBSo2DnPpj6fEqz6iQBivJSs9YPlqpG6oNM0IbwbXHNFUFNWLbReTO__hdDyu5c18_KnSP1d5DiGNVFMNM-xiHmKw17VnIlhnBKVdlidwGfBhId-xhdpvVf2HfCmlz6RPSVuT5sMBz33-Cv1AVcqaN_naW9U4b3NLuL9TUHqCffwOBBnlfuBwNVlshu2bQQrT1tf6SFjoXCemu4NJZxSRICaTByzWB6zorBfdamDhHDMIofQHRJoXoYr2eOUfZ_aR_Wm2iJI2DMEqhpdcfcAfncfg6iN_BD-QdTBgEyWo6c47C6JS8hZZmVOQtTLJu7kyXjhOs7QF7ZWvG28uH0fdklUKSBmmYpOEqgfGlAwDwS_dtPyPW_Ei1-BlHC_BnD2Ouynor9WgBl_thjx_tn68O8RUygzllZrSA0bE_f-H6c9efgz9f-P7C90cHYHtnhOSGclVLu2HuH2q_F9oo21RqdtfW2Ohws8jthoOBrMtyz3TIYy_-XuH42fz4Wbf26-xrM8j-lww6h18Ww_HXxOBcjZdPVXhnK1z_o8LNYxXeDVS4_rzCO9r0FW6ervBusMLW9-M7gtNT-MxRQwvr6WwTk_BV1HtqphCTMxKTaEWSv92aCbOWyNvzdRBGMNmcpzMg0ZspJGRtvXwHZ_HmNbQQJKAkzvpf5kYtHdd1XUdIiZX7kxISJrxSWk8duLv97e72093tJ9CcSWjhkukTJfHqkSVzo7ql2_ulQpQGKw0T-0qaOn8GAAD__2xxZiM=

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfY6-4sIvdgZLkWJ0CGTkQXWYTpsrB5LStQgCgqKolatEpiKlWRsG9CP8K_uBfUq-ZKBUOO6mLOja-cGArs495_Do0LbhFasVl8KHlaTvakno24vnwLaMZg0vc1aDZkpDO6AsK0Ep5ESTjCgG5zA1b6dLANuGnBWkKTW0pGyYDwOUK63el3AOsihGYaTRsodykbMtrhmVVcVETjSXQmEmSFay_F8IpOjXaybrnNX4Z8mFwiWvuIZz-HYxunM2HGS1vk5SFEOC0jSMXkDBiG5q5rSMalnj3pHz4GCq64aNH7YgpWKjnOp96dA6zzAXmtWClI42fLiWv2ClieZKc6ocorAssOZVn6rt_fmHGleyPVc9KvQRq5yH3KeyKMaZ9smPMRlryjGQimhOMZVlyaj5JoeB9MceZzdZ_Rf2iguTy5CQMiLPxgWeue4T_IWsGSVKq69nWXVKswr3n1Bhc4Bh_hUEWkaHwuVMs7riom8GLvi2uVOf00LrOkH9rV1aqxgFKYI0eL5GcNdkJafOFmbWEYEwSs8g2qQQXa_Xc-so-zgZnlabKEnjIIxS2OK7d6yDqzh8GcRv4Af0BmYEgmR1PLeOwugCvYYtzjDPtzDL-rl1vLSsYG0OOCgbM85ePoy-R6sUkjRIwyQNVwlMbywAgN_6f_ObkPYnrPivbOKDO38YU1k2lVATH272wwE_2T_fHuJrRjTLMdETHyanrndmu57teuB6vuv6rjs5AJs7wwXVmMpGmAXPPdR-y5WWpqlYd3fG2ORwmedm4WAgmrLcMx3ymIu_VzhdeKeL_t3v8y_NIPtfMugdfl4Mp18Sg3U7XT5V4c5UuPlHhdvHKtyNVLj5tMIdbocKt09XuButsPH9-EZwcQGfOGpxYTxdbmIUvogGT-0xxOgSxShaoeRvt2ZGjCX0-modhBHMNlfpHFD06hgStDZevoHLePMSOvjxOxQjaOAcFkvLtm3bUpQI6Cy43-3udx_udx-ASqF0TbjQPpx4PtycLMCGk8Wt9VcAAAD__ySYWt4=

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFunEYUfTZfcbUvu64WDF4lslj5gazHKe2GtQCniSxrNAxDMw3MOMxAl1aV8hH-lf5AP8VfUg1E602LY6Vx92ElLveec-7hzNg2vGa14lL4sJL0fS0JfXf2AtiW0azhZc5q0ExpaIcuy0pQCjnRJCOKwSlMzdvpEsC2IWcFaUoNLSkb5sPQypVWH0o4BVkUo22k0bJv5SJnW1wzKquKiZxoLoXCTJCsZPkXAKTox2sm65zV-BfJhcIlr7iGU3i-GJ05GRZZrS-TFMWQoDQNo5dQMKKbmjkto1rWuFfk3CuY6rph48sWpFRsFFN9KB1a5xnmQrNakNLRBg_X8lesNNFcaU6VQxSWBda86l21vb_-VONMtueqB4k-9Srn3vepLIpxpJ3zX0Qa93X6fDEOevIgollWOYa0IppTTGVZMmq-8r7FvZHj0Mb9_4JecWGcHjxXhuTZOMEz130Ev5A1o0Rp9XSSVac0q3AfCoXNAkP9CQhaRocI50yzuuKizxou-La5UV-Ta-syQf09sLRWMQpSBGnwYo3gpslKTp0tzKwDAmGUnkC0SSG6XK_n1kH2qTI8rTZRksZBGKWwxTfvWQcXcfgqiN_Cj-gtzAgEyepwbh2E0Rl6A1ucYZ5vYZb1detwaVnB2iw4MBsxzo4-jH5AqxSSNEjDJA1XCUyvLACA3_t_85uQ9mes-G9s4oM7vy9TWTaVUBMfrnbFoX-ye77e768Z0SzHRE98mBy73onterbrgev5ruu77mSv2ZxCLqjGVDbCDHjuPvc7rrQ0ScW6uzHCJvvDPDcDewXRlOUOaR_HXCU7huOFd7zo3_0x_1YPsv_Fg17h19lw_C02WNfT5WMR7kyEm39FuH0owt1IhJvPI9zhdohw-3iEu9EIG90PTwRnZ_CZohYXRtP5Jkbhy2jQ1B5CjM5RjKIVSv5xambESEJvLtZBGMFsc5HOAUWvDyFBa6PlOziPN6-gg5--RzGCBk5hsbRs27YtRYmAzoK729u72493tx-BSqF0TbjQPhx5PlwdLcCGo8W19XcAAAD__2OwdUg=

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFunEYUfTZfcbUva1cLBq8SWaz8QNbjlHbDWoDTRJY1GobBmQZmHGagi6tK-Qj_Sn-gn-IvqQai9abFsdKk-7ASl3vPOXPuYWwbXrNacSl8WEr6vpaEvjt9AWzDaNbwMmc1aKY0tEOXZSUohZxokhHF4ASm5u10AWDbkLOCNKWGlpQN82Fo5UqrDyWcgCyK0TbSaNm3MkGykuFbfn1LrvGvkgszJUaHZFH0M1zkbINrRmVVMZETzaVQeEDKv0AqRT9eM1nnrO7JFC55xTWcwPP56MzxcPjl6iJJUQwJStMwegkFI7qpmdMyqmWNe0XOg4Kprhs2blBBSsVGMdWH0qF1nmEuNKsFKR3de1PL37DSRHOlOVUOUVgWWPOq34Tt_fWnGmeyPVc9SvSpVzkPu5rKohhH2m7ri0jjvk6fz8dBjx9FNIdVjiGtiOYUU1mWjJot71rcGzkObdz_L-gVF8bpwXNlSJ6NEzxz3SfwC1kzSpRW30-y6pRmFe5DobA5wFD_DgQto0OEc6ZZXXHRZw0XfNPcqK_JtXWRoP7uWFjLGAUpgjR4sUJw02Qlp84G9q09AmGUHkO0TiG6WK1m1l72qTI8LddRksZBGKWwwTfvWQfncfgqiN_Cz-gt7BMIkuXBzNoLo1P0BjY4wzzfwH7W162DhWUFK3PAgdmIcbb0YfQTWqaQpEEaJmm4TGB6aQEA_N7_m9-EtNdY8Vs28cGdPZSpLJtKqIkPl9vi0D_ZPl_t9teMaJZjoic-TI5c79h2Pdv1wPV81_Vdd7LTbL5CLqjGVDbCDHjuLvc7rrQ0ScW6uzHCJrvDPDcDOwXRlOUWaRfHXCVbhqO5dzTv3_0x-1YPsv_Fg17h19lw9C02WFfTxVMR7kyEm39FuH0swt1IhJvPI9zhdohw-3SEu9EIG92PTwSnp_CZohYXRtPZOkbhy2jQ1B5AjM5QjKIlSv7x1ewTIwm9OV8FYQT76_N0Bih6fQAJWhktP8BZvH4FHfzyI4oRNHAC84Vl27ZtKUoEdBbc393d3328v_sIVAqla8KF9uHQ8-HycA42HM6vrL8DAAD__9WihsU=

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvo6e4sA3dgbLkWO0CGzkQnWYTpsrB5LStQgCgqKolKtEuiSlWRkG9CHyKnuBPUqeZKBUOO6mNOja-cKAjs73w0-f5LrwminNpZjDUtL3ShL67uwFsC2jacWLjCkwTBuouy3HiVECGTEkJZrBKQzt3eECwHUhYzmpCgM1KSo2h26Va6M_FHAKMs9710hlZLvKBEkLhm_5zS25wb9KLixK9IJknrcYLjK2xYpRWZZMZMRwKTTumLIviErRwuXG8JLfMoUrzfA7ro28UaTUTyMVkypjqrWpccFLbuAUns96MSddbMvVZZygCGKUJEH4EnJGTKXYpGbUSIXbs0wevA-Nqlh_tDkpNOvl1B-KCVVZirkwTAlSTEybqpK_YW2I4dpwqidEY5ljw8v2GbrTv_7U_Uru1NOPCn3a1ZOHpzyUed7PtHvOX2Tqz3X4fNZPevIooz2snljRkhhOMZVFwajtx37EbZD91Db9_8JecmGT7jK3TRo-6xd45nlP8OdSMUq00d_Psm60YSVuS6GxPUA3_w4CNaNdhTNmmCq5aLuGc76tNvpreu1cxqj96iycZYT8BEHiv1gh2FRpwelkCyPngEAQJicQrhMIL1ersXOQfpp0V8t1GCeRH4QJbPHmPWvgIgpe-dFb-Bm9hREBP14ejp2DIDxDb2CLU8yzLYzSdu4cLhzHX9kDdsrWzGQnH4Q_oWUCceInQZwEyxiGVw4AwO_tv_0NSH2DNb9lgzl444cxlUVVCj2Yw9Vu2O0PdtfX-_uKEcMyTMxgDoNjb3rielPXm4I3nXve3PMGe8v2LeSCGkxlJSxg6u1rt58321Rsmo01NtgH88wC9gaiKood0z6P_ZTsFI5n0-NZe--P8bdmkP4vGbQOvy6G42-JwbkeLp6qcGMrXP2rwvVjFW56Klx9XuEG112F66cr3PRW2Pp-HOGfncFnjmqcW0_n6wgFL8POU30IETpHEQqXKP7HWzMi1hJ6c7HygxBG64tkDCh8fQgxWlkvP8B5tH4FDfzyI4oQVHAKs4Xjuq7raEoENA7c393d3328v_sIVAptFOHCzOFoOoeroxm4cDS7dv4OAAD__-v8mxA=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvTgbLkWO0CGzkwXWYTpsrB5LStQgCgqaolKtEuiSlWRkG9CPyK_uBfUq-ZCBVOO6mNMva-sGAru4599zDI_o-vGZKcykmMJf0vZKEvjt9AWzD6KriRcYUGKYN1G2X5yUohYwYsiKawQn07dv-FMD3IWM5qQoDNSkqNoG2lWujPxRwAjLPO9tIZaRrZYKsCoZv-PUNuca_Si4sSnSCZJ47DBcZ22DFqCxLJjJiuBQat0zZF4ZK4eBybXjJb5jClWb4HddGXitS6qciy6ownMoCa0PMf0ArJlXGlFtS44KX3MAJPB93Yo5b0-eLiyRFMSQoTcPoJeSMmEqxYc2okQo7J4b3m_eNqlj3weSk0KyTU38ohlRlK8yFYUqQYmjcmSj5m1uNa8OpHhKNZY4NL10C_NFff-ruSf4o0A8O-tSrh_cZ6cs872bapuSLTN2-9p-Pu0mPH2R05zi0Q0tiOMVUFgWjNl27Fjsju6mt-_-HveTCOt16bpPUf9Y94FkQPMKfS8Uo0UZ_O8m60YaV2IVCY7tAW_8GA2pG2whnzDBVcuGyhnO-qdb6Kbn2LhLk7qypN4_RLEWQzl4sEKyrVcHpcAP73h6BMEqPIVqmEF0sFgNvb_Wp0j7Nl1GSxrMwSmGD1-9ZA-dx-GoWv4Wf0VvYJzBL5gcDby-MTtEb2OAV5tkG9leu7h1MPW-2sAu2k62Y4XZ8GP2E5ikk6SwNkzScJ9C_9AAAfnf_9tcj9TXW_Ib1JhAM7stUFlUpdG8Cl9ti29_bPl_t9itGDMswMb0J9I6C0bEfjPxgBMFoEgSTIOjtNNuvkAtqMJWVsIBRsDvbXY42qdg0ayustwvmmQXsFERVFFumXR57lWwnHI1HR2P37o_B13qw-i4eOIVPs-Hoa2zwrvrTxyLc2AhX_4pw_VCEm44IV59HuMF1G-H68Qg3nRG2uh9GzE5P4TNFNc6tprNljMKXUaupPoAYnaEYRXOU_OOr2SdWEnpzvpiFEewvz9MBoOj1ASRoYbX8AGfx8hU08MuPKEZQwQmMp57v-76nKRHQeHB3e3t3-_Hu9iNQKbRRhAszgcPRBC4Px-DD4fjK-zsAAP__qkuxEQ==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJyslN-O0zwQxe_zFHPX70Mkarf0D1v1ogSDKrXZpUmrvbNcZyIMjr31OKU8GC_AkyEniOUiuwi0d1F8_DszZ0aOYzigI2XNNaRWfnZWyI9v3wBeUB4bpUt04JE8nDtVFOWsgFJ4cRSEsIRBOB0sAOIYSqxEoz2chW7wGjqpIk8nDUuwVdUrE423rVSZEi_cobR1jaYUXllDHI04aiyfAFjTXndoXYmOf7LKENeqVh6WMB333pl3jaSbfV6wHeSsKNbZe6hQ-MZhckbpreNtRclDBQPvGuxvthKasJdJJ51IVx65Mh6dETrxgced_cLJC6_IK0mJIG4r7lXdphqPvn-jfqd4NKRHjX5qKXnIfWCrqp_0K_knSf25Dqbjfuj8UWJolpJgWguvJJdWa5Rhyr9H3AbZjw7p_wu9ViYk3WVOwWTSbzAZDv_Ar6xDKcjT85VMX8ljzdulIB4a6P4_g8EZZbfCJXp0tTLtrvFKXZp7-pu9jvY5a9-BRZTu2KpgkLMPe5alDO6bo1YyITzBdp0dVps9gxFsV3fd5-urq_F4djUcT-eTV7PZZD6cwTpLd2zLsgJGkBerXQGjRRSxu9vNap3Bfze3xUtg2eF_yNmGpQW8gHe7my0QnhZRHMdxRHhq0EiMCcOMw0n0IwAA__9XzI6T

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VdFu2zYUfQ6_4sIvtgfJkWO0CGwEmOownTZXCSQlbREEBCVRK1eZTElKszcMKPYNftxv7Af2KfmSgVLqOK3SoGvnBwO6uvecc48PadeFC6Y0l2IKc5m9VZJmb46fAVuxLK14mTMFhmkDdduFUIwTyKmhKdUMjqBv3_ZnAK4LOStoVRqoaVmxKbStXBv9roQjkEXR2UYrI5tWLnK2IoplcrlkIqeGS6EJEzQtWf4ZACmaccWkypkiv0guNCn5khs4gqeTzpnDdpH54jxOcAQxTpIgfA4Fo6ZSbFSzzEhFGkWjOwV9oyrWvWxBS806MfW7cpSpPCVcGKYELUfG4hElfyXaUMO14ZkeUU1kQQxfNq6643_-1t1M7tjTDxLd9urRne99WRTdSFvnP4vU7Wv_6aQb9PBBRLusHlnSJTU8I5ksS5bZX3nX4sbIbmjr_n9BX3JhnW4915bkSTfBE897BL-QimVUG_3tJOu1NmxJmlBoYhdo69-AoGZZG-GcGaaWXDRZIwVfVdf6S3KNzmPc3AMzNI-wn2BI_GcLDNdVWvJstIIB2qMQhMkhhKcJhOeLhYP20ttK-zQ_DeMk8oMwgRW5fsvWcBYFL_zoNfyEX8OAgh_Phw7aC8Jj_ApWJCU8X8EgbepoOEPIX9gFW2YrZrSlD8If8TyBOPGTIE6CeQz9SwQA8HvzbT89Wv9MNP-N9abgOXflTJbVUujeFC63xba_t32-2u1XjBqWE2p6U-gdeOND1xu73hi88dTzpp7X22m2p5CLzJBMVsIOjL1d7jdcG2mTSsz62grr7Q7z3A7sFERVllukXRx7lWwZDibjg0nz7g_naz1I_xcPGoVfZsPB19iArvqzxyK8thGuPolw_VCE1x0Rru5HeE3qNsL14xFed0bY6n54wj8-hnuKalJYTSenEQ6eh62meggRPsERDuc4_ujUDOiwy5eLAL_8YEvdnGx7lh20V1lD0BD8GGK8sGqpA6kDlQM1nESnL-7jOx_pffkDjjCkcASTGUL41dnCD0IYnJ4lDuDwYvgB9LsWq54h13VdxIVgyrX_PjDIlNR6iOBm89fN5v3N5j3ojApYf1JZfX97gdg3f9oU3Gw2tw2ZFNooyoWZwv7B_ngKl_sTcGF_coV22gpeGqY0DOzlOET_BgAA___r9bnM

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJyslNFO3DwQha_xU8xd4BeJQAiEWHER8qdV2pBFG4OKqsryOhPVJbHB42yXB-sL9MkqJ1XpRaBqxW1y5jtnTkaJY7hBR9qaM8isunNWqs__XwBuUa0H3TXowCN52EwqxuqcQyO9XEtCOIcovI0WAHEMDbZy6DxsZDfgGUxSTZ4eOjgH27azMjl4O0q1aXArHCrb92ga6bU1JNDIdYfNCwBrxnGH1jXoxBerDYlO99rDOZwczc6cTotk5XXN8xXUOedF9RZalH5wmGxQeevEmCh5ShB5N-D8sq3sCGeZ9NAlyjVroY1HZ2SX-MATzn4V5KXX5LWiRJKwrfC6H1uND79_o3mn-PCAnjX6qaXkqffItu086VfzL5Lme41Ojuahp88Sw7KUBNNeeq2Esl2HKnzl3ysei5xHh_b_hd5rE5qeOqdgcjxvcHxw8Ad-ax0qSZ5eLzI9ksdejEdBIiwwPX8Fgw2q6YQb9Oh6bcZbE63eDvf0N3fNrut8_A8sWLbKU54DTy_KHCjxsMt2JBQVP4VqyaG6Lst9tpMtq5qv0qLi4MX9HT7C1aq4TFe38D6_hV0JaZ3tsb0FY2kZUk-44JAEZlG9yzMONU95UfMiqyH6-ClaMJZ_uCrTooLd5RXfh7y62YM6L4P2P3izWl6GRAsWx3HMSEkDnv0IAAD__6Sckyk=

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xexsA5FgI0gQJPAiTYUigOEGtWN0R4ypUcqGImvOyHV2OYSv0gv0KD5JQaloumBSNMiWGr4_fPp5DisKbLw7hyuv74NH_eX9O6Ad6XVrbEUBhFhg209l2aJcQoWCa2SCKQzi18EFQJ5DRTW2VmCLtqVz6Ef7MyUBHaMW453atGiNPChfK6awNTqC1qjv74JvXZWEBbprLYaeaVh4Y2EKvq6T09iK70aNq2inAmnfNOQqjPmsyOHaUvUCwLvueiAfKgrqqzeOlTWNEZjC6XHyzlkv52p2u1iWn2BRLpfX8w9QE0obqNiSFh9Ut1HxtMFAQktpgTVapiSTN7bQoVor44SCQ1tI5KngvysWFMNiNBfI0bGYpvtT-eTnD04n5ZMxPxv0e5aLJ-8DX9dp0h_zL5LSXgenx2no2bPE-FguYmiDYrTS3lrqWva34k5kGh3tv4beGBdN9845hpykA07G43_wax9IIwu_3cr8wEKN6krBKj6gP3-DgC3pvsIVCYXGuK5rqja79hv_T6-z8vPN7PJ6DsOPN8sjKOerEawuZ7flAoaT0UWW53medTc4g8N-f9g_HvaPMJwcjbJfAQAA__93FZMj

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zoQhvc6xexsA5FgI0gQJPAiL08oAhhuUDtGd8SYGrVsKbLmjFRnl0P4Kr1Aj-KTFJSKpgsmRYtsqeH3Dz_9eQ4bCmy8u4Qbrz8Hj_rj__8B7UlvW2MrCiDEAt0wlWWrcg0VCm6RCeYwil9HVwB5DhXV2FqBDm1LlzCMDmdKAjpGLcY7tWvRGnlQvlZMoTM6gnQwYjTaJCrQh9ZiGIiGhXcW5uDrOjmNrfh-1LiK9iqQ9k1DrsKYzoocbi1VLwC8668H8qGioD5541hZ0xiBOZyfJu9cDGpuFverdfkOVuV6fbt8AzWhtIGKjrT4oPqNiqcNRhJaSuur0TIlmbyzhQ7VVhknFBzaQiJPBf9VsaAYFqO5QI6GxTT9f8pn379xOimfTfnZoJ-zXDx5H_m6TpN-mX-RlPY6Oj9NQy-eJcbHchFDGxSjlfbWUt-x3xX3ItPoaP9f6I1x0fTgnGPIWTrgbDr9A7_2gTSy8OutzA8s1Ki-FKziA4bzVwjoSA8VrkgoNMb1XVO12bdf-G96nZXv7xbXt0sYv71bn0C53Exgc724L1cwnk2usjzP86y_wRkcD4fj4fF4eITx7GSS_QgAAP__nfCSTg==

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgfLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMlOiSlWR72WfuBfdlAqXCcVm7WtfWDAV3de865R4d0XXjNlOaynMNS0o2ShH68fgFsx2hacZExBYZpA3XX5TgxSiAjhqREM7iCoX07XAC4LmQsJ5UwUBNRsTl0rV0NG0VKTajhssT3FRHcNFjmWDNVc2qBqOKGUyJ6oRT7UAmiOkSujb4XcAUyz3u7SWVk28rLjO2wYlQWBSszYtk1ZiVJBcu-AiDLdlwxqTKm8O-SlxoLXnADV_D8onfmsrNmubqLExRBjJIkCF9CzoipFJvWjBqpcKto-qBgaFTF-u3LidCsF1PfiylVWYp5aZgqiZgai4eV_ANrQwzXhlM9Jdo6bHjRfid39s_fup_JnXn6JNGnXj198H0o87wf6eD8V5H6fR0-v-gHvTyJaJfVU0taEMMpplII1mbs2OLWyH5o6_7_QS94aZ3uPNeW5Fk_wTPPewI_l4pRoo3-cZJ1ow0rcBsKje0CXf0HENSMdhHOmGGq4GWbNZzzXbXV35Jr5y5G7c2ycJYR8hMEif9ihWBbpYLT6Q5GzhmBIEwuIVwnEN6tVhPnLP1U6Z6W6zBOIj8IE9jh7YY1cBsFr_zoLfyG3sKIgB8vxxPnLAiv0RvY4RTzbAejtK0744Xj-Cu7YMdsxUwP9EH4K1omECd-EsRJsIxh-M4BAPiz_be_Aak_YM33bDAHb_JQplJURakHc3h3KHb9g8Pz--N-xYhhGSZmMIfBuTe7dL2Z683Am809b-55g6Nmewp5SQ2msirtwMw75v7ItZE2qdg0WytscDzMMztwVCgrIQ5Ixzj2KjkwnF_Mzi_ad39NvteD9Kd40Cr8NhvOv8cG5_1w8VSEGxvh6osI16ci3PREuHoc4QbXXYTrpyPc9Eb4P-jeW93bzRfCFctPSd_3SN9unta4P6nx9Fb-9TU8cq3GuSW_WUcoeBl25PUYInSDIhQuUfzZyR6R8Wn8_ef4-eYxsmL5SewGRpVdF725XflBCKP1bTIBFL4eQ4xWds9f4CZav4L9wnFd13U0JSXsnX8DAAD__yRwy8M=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgfLkBO0CGzkQXWYQpsrB5JStCgKgqKoljMlOiSlWR72WfuBfdlAqXCcVm7WtfWDAV3de865R4d0XXjNlOaynMNS0o2ShH68fgFsx2hacZExBYZpA3XX5TgxSiAjhqREM7iCoX07XAC4LmQsJ5UwUBNRsTl0rV0NG0VKTajhssT3FRHcNFjmWDNVc2qBqOKGUyJ6oRT7UAmiOkSujb4XcAUyz3u7SWVk28rLjO2wYlQWBSszYtk1ZiVJBcu-AiDLdlwxqTKm8O-SlxoLXnADV_D8onfmsrNmubqLExRBjJIkCF9CzoipFJvWjBqpcKto-qBgaFTF-u3LidCsF1PfiylVWYp5aZgqiZgai4eV_ANrQwzXhlM9Jdo6bHjRfid39s_fup_JnXn6JNGnXj198H0o87wf6eD8V5H6fR0-v-gHvTyJaJfVU0taEMMpplII1mbs2OLWyH5o6_7_QS94aZ3uPNeW5Fk_wTPPewI_l4pRoo3-cZJ1ow0rcBsKje0CXf0HENSMdhHOmGGq4GWbNZzzXbXV35Jr5y5G7c2ycJYR8hMEif9ihWBbpYLT6Q5GzhmBIEwuIVwnEN6tVhPnLP1U6Z6W6zBOIj8IE9jh7YY1cBsFr_zoLfyG3sKIgB8vxxPnLAiv0RvY4RTzbAejtK0744Xj-Cu7YMdsxUwP9EH4K1omECd-EsRJsIxh-M4BAPiz_be_Aak_YM33bDAHb_JQplJURakHc3h3KHb9g8Pz--N-xYhhGSZmMIfBuTe7dL2Z683Am809b-55g6Nmewp5SQ2msirtwMw75v7ItZE2qdg0WytscDzMMztwVCgrIQ5Ixzj2KjkwnF_Mzi_ad39NvteD9Kd40Cr8NhvOv8cG5_1w8VSEGxvh6osI16ci3PREuHoc4QbXXYTrpyPc9Eb4P-jeW93bzRfCFctPSd_3SN9unta4P6nx9Fb-9TU8cq3GuSW_WUcoeBl25PUYInSDIhQuUfzZyR6R8Wn8_ef4-eYxsmL5SewGRpVdF725XflBCKP1bTIBFL4eQ4xWds9f4CZav4Jm4biu6zqakhIa598AAAD__yRfy8E=

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfY6-4sIvtgfLkBO0CGzkwXWYQpsrB5JStCgKgqKoljMlOiSlSR72WfuBfdlAqXCcVm7WtfWDAV3de865R4d0XXjNlOaymMNK0q2ShH68fgGsZjQpuUiZAsO0garrcpwIxZASQxKiGVzB0L4dLgBcF1KWkVIYqIgo2Ry61q6GjSKFJtRwWeD7kghuGiwzrJmqOLVAVHHDKRG9UIp9KAVRHSLXRt8LuAKZZb3dpDSybeVFymqsGJV5zoqUWHaNWUESwdKvAMiiHVdMqpQp_LvkhcaC59zAFTy_6J257KxZre-iGIUQoTj2g5eQMWJKxaYVo0Yq3CqaPigYGlWyfvsyIjTrxdT3YkpVmmBeGKYKIqbG4mEl_8DaEMO14VRPibYOG56338md_fO37mdyZ54-SfSpV08ffB_KLOtHOjj_VaR-X4fPL_pBL08i2mX11JLmxHCKqRSCtRk7trg1sh_auv9_0HNeWKc7z7UledZP8MzznsDPpGKUaKN_nGTdaMNy3IZCY7tAV_8BBBWjXYRTZpjKedFmDWe8Lnf6W3Lt3EWovVkWzipEyxhBvHyxRrArE8HptIaRc0bAD-JLCDYxBHfr9cQ5Sz5VuqfVJojicOkHMdR4t2UN3Ib-q2X4Fn5Db2FEYBmtxhPnzA-u0RuocYJ5WsMoaevOeOE4y7VdsGO2YqYHej_4Fa1iiOJl7Eexv4pg-M4BAPiz_be_Aak-YM33bDAHb_JQplKUeaEHc3h3KHb9g8Pz--N-xYhhKSZmMIfBuTe7dL2Z683Am809b-55g6Nmewp5QQ2msizswMw75v7ItZE2qdg0OytscDzMUztwVChKIQ5Ixzj2KjkwnF_Mzi_ad39NvteD5Kd40Cr8NhvOv8cG5_1w8VSEGxvh8osIV6ci3PREuHwc4QZXXYSrpyPc9Eb4P-jeW9277RfCFctOSd_3SN9tn9a4P6nx9FbL62t45FqFM0t-swmR_zLoyKsxhOgGhShYoeizkz0i49P4-8_xs-1jZMWyk9gNjEq7Lnpzu176AYw2t_EEUPB6DBFa2z1_gZtw8wrqheO6rutoSgqonX8DAAD__yROy78=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0VOFu2zYX_R09xYX_2P5gGXKCFoGN_HAdptA3Vw4kpWhRFARFUS1nSnRISrM87LH2AnuygVLhuKnULGvnHwZ0de855x4d0nXhLVOay2IOK0m3ShL6-foVsD2jSclFyhQYpg1UbZfjRCiGlBiSEM3gCob27XAB4LqQsoyUwkBFRMnm0La2NWwUKTShhssC35dEcFNjmWHNVMWpBaKKG06J6IRS7FMpiGoRuTb6XsAVyCzr7CalkU0rL1K2x4pRmeesSIll15gVJBEs_Q6ALJpxxaRKmcK_Sl5oLHjODVzBy4vOmcvWmtX6LopRCBGKYz94DRkjplRsWjFqpMKNoumDgqFRJeu2LyNCs05MfS-mVKUJ5oVhqiBiaiweVvI3rA0xXBtO9ZRo67DhefOd3Nlff-puJnfm6V6iL716-uD7UGZZN9LR-e8idfs6fHnRDXrZi2iX1VNLmhPDKaZSCNZk7NTixshuaOv-v0HPeWGdbj3XluRFN8ELz3sCP5OKUaKN_nmSda0Ny3ETCo3tAm39JxBUjLYRTplhKudFkzWc8X2508_JtXMXoeZmWTirEC1jBPHy1RrBrkwEp9M9jJwzAn4QX0KwiSG4W68nzlnypdI-rTZBFIdLP4hhj3dbVsNt6L9Zhu_hF_QeRgSW0Wo8cc784Bq9gz1OME_3MEqaujNeOM5ybRdsma2Y6ZHeD_6PVjFE8TL2o9hfRTD84AAA_N7829-AVJ-w5gc2mIM3eShTKcq80IM5fDgW2_7B8fnjab9ixLAUEzOYw-Dcm1263sz1ZuDN5p4397zBSbM9hbygBlNZFnZg5p1yf-baSJtUbOqdFTY4HeapHTgpFKUQR6RTHHuVHBnOL2bnF827PyY_6kHyn3jQKHyeDec_YoPzcbh4KsIHG-Hd9psMK5b1pfjQkeLd9um4Hjrj-g801lZj-Y3Eqk9g3SGw_PqY1bhqj1n1tO66V3f_psvrazhRlG3hZhMi_3XQqlEsG0OIblCIghWKHtGNynE_dv0Y266S2X2_Yqh68fcwIs_Bf6y9H_lgc2CdRO9u10s_gNHmNp4ACt6OIUJra-H_4CbcvIF64biu6zqakgJq5-8AAAD__3tj5tY=

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "id": 1,
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "id": 2,
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy0lOFu2zYQxz-HT3HwFyeDJchK06U28kFx1EGbKgeWErQoCoKiqJYrRSYk5SYb9lh7gT3ZQKp1jEHN1iH1BwO--9__jj-eGQRwzbThSi5gpehHrQj9cHEO7I7RuueiYRosMxa2gwqhMq2gIZbUxDA4g6nLTpcAQQANa0kvLGyJ6NkCBukQw1YTaQi1XEl82xPB7T1WLTZMbzl1RlRzyykRo1aave8F0YMjN9bcCjgD1bajatJb5aVcNuwOa0ZV1zHZENfdYCZJLVjziIGSvlwzpRum8a-KS4MF77iFM3h-PFpzOqBZ5VdllW6gTKsqK36ClhHbaxZuGbVKYz9R-DDB1OqejeNriTBs1NPcipDqpsZcWqYlEaF1flirT9hYYrmxnJqQGEfY8s7fUzD_608z3imYR-arjT5rTfjAfaradtxpR_5Rp3Gu0-fH46anX3V0hzWha9oRyymmSgjmd2wfsQc5bu3o_x_3jktHemBuXJOT8QYnUfQv_q3SjBJjzdONbO6NZR32S2GwO8AQf4IGW0aHFW6YZbrj0u8abvldf2O-Za_RVZn6l2WJVps0qVKokvM8hZu-FpyGNRyigxrO1-scinUFxVWez9CBVp94A1lRnfrodVZmruiLAi7Sl8lVXkEv-W3vL4c3h0czdLBaF2W1SbKighrffGT3cLnJXiWbN_BL-gYOB9-kXDltVlykr6HGNebNHRzWPo6OlgglueMxDOpmD3fTZsXP6aqCskqqrKyyVQnTtwgA4Hf_7T4Tsn2PDf-NTRYwnz2EqRJ9J81kAW93QZ-oJ7vf7_b1mhHLGkzsZAGTOIrjYB4HUQzz08Xxs0X8Ijz58dmL43iyV-P-u1xSi6nqpauL95IfuLHKbTe29zduusl-KW_-Ma8knRdhv1kY74tlL8SuR7SXcE_Tl_h8HkU-88fsEUTRf0Hk7-07Yoq-DVP8lJg-M0LvpkuE0teXeZIVcLi-rGaQFtdHUKa5W7kf4OVm_QrqJQqCIECGEgk1-jsAAP__j3tSbg==
